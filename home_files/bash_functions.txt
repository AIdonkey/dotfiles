# BASH FUNCTIONS

#--------------------------#
# Git (http://git-scm.com) #
#--------------------------#

# Git Root - Changes to project root directory (regardless of how deep the current path might currently be).
function groot() {
  cd "$(dirname $(git rev-parse --git-dir))"
}

# Git Status (all) - Answers the status of projects with uncommited changes.
function gsta() {
  echo ''
  root_path=`pwd` # Remember root directory.

  # Iterate project directories located in root directory.
  for directory in `ls -d1 -- */`
  do
    # Process projects that are Git enabled only.
    cd "$root_path/$directory"
    if [ -d ".git" ]; then
      # Capture current project status.
      results=$(git status -s)
      # Print project name and Git activity only if Git activity was detected.
      if [ -n "$results" ]; then
        echo -e "\033[36m${directory/%?/}\033[m" # Outputs in cyan color.
        echo -e "$results"
      fi
    fi
  done

  cd "$root_path" # Return to root directory.
  echo ''
}

# Git Since - Answers a summarized list of Git activity since a specifiy date/time for all projects
# in current directory, broken down by project.
# Parameters:
# $1 = The past date/time from which to log activity up to now.
function gince() {
  echo ''
  root_path=`pwd` # Remember root directory.

  # Iterate project directories located in root directory.
  for directory in `ls -d1 -- */`
  do
    # Process projects that are Git enabled only.
    cd "$root_path/$directory"
    if [ -d ".git" ]; then
      user=$(git config user.name)
      # Capture git log activity.
      results=$(git log --oneline --format='%C(yellow)%H%Creset %s' --author "$user" --since "$1" --reverse)
      # Print project name and Git activity only if Git activity was detected.
      if [ -n "$results" ]; then
        echo -e "\033[36m${directory/%?/}" # Outputs in cyan color.
        echo -e "$results\n"
      fi
    fi
  done

  cd "$root_path" # Return to root directory.
}

# Git Standup - Answers a summarized list of Git activity since yesterday for all projects in current directory,
# broken down by project. This is a great way to see what you did yesterday for today's standup report.
function gsup() {
  gince "yesterday"
}

# Git Today - Answers a summarized list of Git activity (today only) for all projects in current
# directory, broken down by project.
function gday() {
  gince "12am"
}

# Git Tail - Answers the commit history from the last tag (i.e. tail end of unversioned/untagged commits).
function gtail() {
  if [ "$(git tag)" ]; then
    git log --oneline --format='%C(yellow)%H%Creset %s' --reverse $(git describe --abbrev=0 --tags)..HEAD
  fi
}

# Git Tail (all) - Answers tail count (see gtail function for details) for all projects within current directory.
function gtaila() {
  echo ''
  root_path=`pwd` # Remember root directory.

  # Iterate through root project directories.
  for project in `ls -d1 -- */`
  do
    # Process projects that are Git-enabled only.
    cd "$root_path/$project"
    if [ -d ".git" ]; then
      # Count outstanding commits.
      count=$(gtail | wc -l | xargs -n 1)
      # Print project name and Git activity only if Git activity is detected.
      if [ -n $count ] && [ $count != 0 ]; then
        # Outputs project (cyan color) with color-coded commit count (based on volume).
        if [ $count -ge 20 ]; then
          echo -e "\033[36m${project/%?/}:\033[m \033[31m$count\033[m" # Red count color.
        elif [ $count -ge 10 -a $count -le 19 ]; then
          echo -e "\033[36m${project/%?/}:\033[m \033[33m$count\033[m" # Yellow count color.
        else
          echo -e "\033[36m${project/%?/}:\033[m $count" # White count color.
        fi
      fi
    fi
  done

  cd "$root_path" # Return to root directory.
  echo ''
}

# Git Commit and Push (all) - Commits and pushes changes for all projects within current directory. Useful
# when making the same change across multiple projects.
# Parameters:
# $1 = The commit message.
function gcap() {
  echo ''

  if [ "$1" ]; then
    root_path=`pwd` # Remember root directory.

    # Iterate project directories located in root directory.
    for project in `ls -d1 -- */`
    do
      # Only process projects that are Git-enabled.
      cd "$root_path/$project"
      if [ -d ".git" ]; then
        # Only process projects that have changes.
        if [ "$(git status -s)" ]; then
          git commit -a -m "$1" && git push
        fi
      fi
    done

    cd "$root_path" # Return to root directory.
  else
    echo "ERROR: Commit message must be supplied."
  fi

  echo ''
}

# Git Branch Delete - Deletes local and associated remote branch (if found).
function gbd() {
  echo ''

  if [ "$1" ]; then
    read -p "You are about to delete the '$1' branch from local and remote repositories. Continue (y/n)?: " response
    if [ "$response" == 'y' ]; then
      git branch -d "$1"
      if [ -n "$(git branch --remotes --list $1)" ]; then
        git push origin :"$1"
      else
        echo "No remote branch found. Skipped."
      fi
    else
      echo "Branch deletion aborted."
    fi
  else
    echo "ERROR: Branch name must be supplied."
  fi

  echo ''
}

# Git Branch Delete Merged - Deletes all local and associated remote branch (if found) merged branches.
function gbdm() {
  branches=$(git branch --merged | grep -v "\*" | xargs -n 1)
  for branch in $branches
  do
    gbd $branch
  done
}

#-----------------------------#
# GitHub (https://github.com) #
#-----------------------------#

# Initizalize GitHub - Initializes a new GitHub repo with sensible defaults.
# Reference: https://gist.github.com/1105392
# ==== Parameters
# * +user+ - Required. The GitHub user account name.
# * +repo+ - Required. The repo name.
function init_github() {
  git remote add origin git@github.com:$1/$2.git
  git push origin master
  git config branch.master.remote origin
  git config branch.master.merge refs/heads/master
  git config push.default current
}

#----------------------------------------#
# Ruby on Rails (http://rubyonrails.org) #
#----------------------------------------#

# Rails New - Builds a new rails app for given template selection.
# ==== Parameters
# * +name+ - Required. The name of the app to create.
# * +selection+ - Optional. The template to apply. Default: (prompts for choice).
function rew {
  # Set defaults.
  options=''

  # Template options.
  rails_setup_template_options="-d sqlite3 -J -T -f --skip-bundle -m https://raw.github.com/bkuhlmann/rails_setup_template/master/template.rb"
  rails_setup_template_local_options="-d sqlite3 -J -T -f --skip-bundle -m ~/Dropbox/Development/Ruby/rails_setup_template/template.rb"

  # Bypass prompt if selection is supplied.
  if [ $2 ]; then
    case $2 in
      2)
        options=$rails_setup_template_options
        ;;
      3)
        options=$rails_setup_template_local_options
        ;;
    esac
  # Otherwise, prompt for template when selection is unknown.
  else
    echo -e "Usage: rew NAME TEMPLATE"
    echo -e "\nAvailable Templates:"
    echo "  1: Rails Default Template"
    echo "  2: Rails Setup Template"
    echo "  3: Rails Setup Template (local)"
    while true; do
      read -p "Please pick one (or type 'q' to quit): " response
      case $response in
        '1')
          unset options
          break;;
        '2')
          options=$rails_setup_template_options
          break;;
        '3')
          options="-d sqlite3 -J -T -f --skip-bundle -m ~/Dropbox/Development/Ruby/rails_setup_template/template.rb"
          break;;
        'q')
          return;;
      esac
    done
  fi

  # Create new Rails app.
  echo "rails new $1 $options"
  rails new $1 $options
  echo
}

# Rails Script Console
function sc {
  if [ -e script/rails ]; then
    script/rails console $@
  else
    script/console $@
  fi
}

# Rails Script Server
function ss {
  if [ -e script/rails ]; then
    script/rails server $@
  else
    script/server $@
  fi
}

# Rails Script Generator
function sg {
  if [ -e script/rails ]; then
    script/rails generate $@
  else
    script/generate $@
  fi
}

# Rails Script Database Console
function sdb {
  if [ -e script/rails ]; then
    script/rails dbconsole $@
  else
    script/dbconsole $@
  fi
}
